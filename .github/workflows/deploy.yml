name: Deploy to Cloudflare

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  NODE_VERSION: '20' # ä¿®å¤ 1: å‡çº§ Node.js ç‰ˆæœ¬ä»¥å…¼å®¹ Wrangler
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Workers and Pages
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Install frontend dependencies
        run: |
          cd frontend
          pnpm install

      - name: Install backend dependencies
        run: |
          cd backend
          npm ci

      # --- èµ„æºåˆ›å»º ---
      - name: Create D1 database
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ env.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 create sm-auth-survey-db
        continue-on-error: true

      - name: Create KV namespace
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ env.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          command: kv:namespace create "CACHE"
        continue-on-error: true

      - name: Create R2 bucket
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ env.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          command: r2 bucket create sm-auth-survey-files
        continue-on-error: true

      # --- åŠ¨æ€æ›´æ–° wrangler.toml ---
      - name: Update wrangler.toml with actual resource IDs
        id: update_toml
        run: |
          cd backend
          
          # èŽ·å– D1 æ•°æ®åº“ ID
          D1_ID=$(npx wrangler d1 list --json | jq -r '.[] | select(.name=="sm-auth-survey-db") | .uuid')
          echo "D1 Database ID: $D1_ID"
          
          # ä¿®å¤ 2: ä½¿ç”¨ jq ä»Ž JSON è¾“å‡ºä¸­èŽ·å– KV ID
          # æ³¨æ„ï¼šWrangler å¯èƒ½ä¼šè‡ªåŠ¨ä¸º KV å‘½åç©ºé—´æ·»åŠ é¡¹ç›®å‰ç¼€ï¼Œä¾‹å¦‚ "my-project-CACHE"
          # æˆ‘ä»¬ä½¿ç”¨ contains æ¥è¿›è¡Œæ›´çµæ´»çš„åŒ¹é…
          KV_ID=$(npx wrangler kv:namespace list --json | jq -r '.[] | select(.title | contains("CACHE")) | .id')
          echo "KV Namespace ID: $KV_ID"
          
          if [ -z "$D1_ID" ] || [ -z "$KV_ID" ]; then
            echo "Error: Failed to retrieve D1 or KV resource IDs."
            exit 1
          fi
          
          # ä½¿ç”¨ sed æ›¿æ¢ wrangler.toml ä¸­çš„å ä½ç¬¦
          sed -i "s/database_id = \".*\"/database_id = \"$D1_ID\"/" wrangler.toml
          sed -i "s/id = \".*\"/id = \"$KV_ID\"/" wrangler.toml
          sed -i "s/preview_id = \".*\"/preview_id = \"$KV_ID\"/" wrangler.toml
          
          echo "wrangler.toml updated successfully."
          cat wrangler.toml # æ‰“å°æ›´æ–°åŽçš„æ–‡ä»¶å†…å®¹ä»¥ä¾›è°ƒè¯•

      # --- æ•°æ®åº“è¿ç§» ---
      - name: Run database migrations
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ env.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          # ä¿®å¤ 3: æ·»åŠ  --remote æ ‡å¿—ä»¥åœ¨è¿œç¨‹æ•°æ®åº“ä¸Šæ‰§è¡Œ
          command: d1 execute sm-auth-survey-db --remote --file=./migrations/0001_initial_schema.sql
          workingDirectory: backend
        # ç¬¬ä¸€æ¬¡è¿è¡ŒåŽï¼Œå¦‚æžœè¡¨å·²å­˜åœ¨ï¼Œè¿ç§»å¯èƒ½ä¼šå¤±è´¥ï¼Œæ‰€ä»¥å…è®¸é”™è¯¯
        continue-on-error: true

      - name: Run initial data migration
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ env.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 execute sm-auth-survey-db --remote --file=./migrations/0002_initial_data.sql
          workingDirectory: backend
        continue-on-error: true

      - name: Run email templates and site configs migration
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ env.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 execute sm-auth-survey-db --remote --file=./migrations/0003_email_templates_and_site_configs.sql
          workingDirectory: backend
        continue-on-error: true

      # --- éƒ¨ç½²åŽç«¯ ---
      - name: Deploy backend to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ env.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
          workingDirectory: backend
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          FROM_NAME: ${{ secrets.FROM_NAME }}
          ALIYUN_ACCESS_KEY_ID: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}
          ALIYUN_ACCESS_KEY_SECRET: ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
          TENCENT_SECRET_ID: ${{ secrets.TENCENT_SECRET_ID }}
          TENCENT_SECRET_KEY: ${{ secrets.TENCENT_SECRET_KEY }}
          ADMIN_NAME: ${{ secrets.ADMIN_NAME }}
          ADMIN_ID_CARD: ${{ secrets.ADMIN_ID_CARD }}
          WECHAT_WEBHOOK_URL: ${{ secrets.WECHAT_WEBHOOK_URL }}

      # --- éƒ¨ç½²å‰ç«¯ ---
      # ä¼˜åŒ– 4: å°†è·¯ç”±é…ç½®æ–‡ä»¶æ”¾åœ¨ public ç›®å½•ä¸­ï¼Œé¿å…äºŒæ¬¡éƒ¨ç½²
      - name: Create Pages API routing configuration
        run: |
          mkdir -p frontend/public
          cat > frontend/public/_routes.json << 'EOF'
          {
            "version": 1,
            "include": ["/api/*"],
            "exclude": ["/api/assets/*"]
          }
          EOF

      - name: Build frontend
        run: |
          cd frontend
          pnpm run build
        env:
          # VITE_API_BASE_URL åº”è¯¥æŒ‡å‘æ‚¨çš„ Worker éƒ¨ç½²åŽçš„ URL
          # å¦‚æžœæ‚¨é…ç½®äº†è‡ªå®šä¹‰åŸŸï¼Œè¯·ä½¿ç”¨å®ƒã€‚å¦åˆ™ï¼Œä½¿ç”¨ *.workers.dev URLã€‚
          # åœ¨è¿™é‡Œæˆ‘ä»¬å‡è®¾ Worker çš„åç§°ä¸Ž wrangler.toml ä¸­å®šä¹‰çš„ä¸€è‡´ (sm-auth-survey-api)
          VITE_API_BASE_URL: https://sm-auth-survey-api.${{ secrets.WORKERS_DEV_URL }} # è¯·ç¡®ä¿åœ¨ secrets ä¸­è®¾ç½®äº† WORKERS_DEV_URL

      - name: Deploy frontend to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ env.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          projectName: sm-auth-survey-frontend
          directory: frontend/dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      # --- è¾“å‡ºéƒ¨ç½²ä¿¡æ¯ ---
      - name: Output deployment info
        run: |
          echo "ðŸš€ Deployment completed!"
          echo "ðŸ“± Frontend URL: https://sm-auth-survey-frontend.pages.dev"
          echo "ðŸ”§ Backend URL: https://sm-auth-survey-api.${{ secrets.WORKERS_DEV_URL }}"
